<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Arial;
      background: #0b1020;
      color: #e8ebf1;
      margin: 0;
      padding: 24px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .card {
      background: #0e1530;
      border: 1px solid #1c2a4a;
      border-radius: 10px;
      padding: 24px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      text-align: center;
    }
    h1 {
      margin: 0 0 20px 0;
    }
    .game-id {
      font-size: 1.2rem;
      color: #a5b4e0;
      margin-bottom: 20px;
    }
    form {
      display: flex;
      justify-content: center;
      gap: 12px;
    }
    input[type=text],
    input[type=number] {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #27365d;
      background: #050815;
      color: #e8ebf1;
    }
    input[type=submit] {
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      background: #11182e;
      border: 1px solid #27365d;
      color: #e8ebf1;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
    }
    input[type=submit]:hover {
      background: #1b2545;
      transform: translateY(-2px);
    }
    input[type=submit]:active {
      transform: translateY(0);
      background: #27365d;
    }
        .portfolio {
      margin-top: 24px;
      text-align: left;
    }
    .portfolio h3 {
      margin-bottom: 8px;
    }
    .portfolio-summary {
      margin-bottom: 12px;
      font-size: 0.95rem;
      color: #c5d0ff;
    }
    table.holdings {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    table.holdings th,
    table.holdings td {
      padding: 8px 10px;
      border-bottom: 1px solid #222b45;
    }
    table.holdings th {
      text-align: left;
      font-weight: 600;
      color: #a5b4e0;
    }
    table.holdings td {
      color: #e8ebf1;
    }
    .charts-wrapper {
      display: flex;
      gap: 20px;
      margin-top: 16px;
    }

    .chart-box {
      flex: 1;
      background: #050815;
      border: 1px solid #1c2a4a;
      border-radius: 10px;
      padding: 12px;
    }
    
        .ticker-btn {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid #2b7cff;
      background: #11182e;
      color: #e8ebf1;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .ticker-btn:hover {
      background: #1b2545;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal.hidden {
      display: none;
    }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
    }
    .modal-content {
      position: relative;
      background: #0e1530;
      border-radius: 10px;
      border: 1px solid #1c2a4a;
      padding: 16px;
      width: 800px;
      max-width: 95%;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
      z-index: 1;
    }
    .modal-close {
      position: absolute;
      top: 8px;
      right: 10px;
      background: transparent;
      border: none;
      color: #e8ebf1;
      font-size: 20px;
      cursor: pointer;
    }
    #tvchart {
      width: 100%;
      height: 420px;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Play</h1>
      {% if ID %}
        <div class="game-id">Game ID: {{ ID }}</div>
      {% else %}
        <div class="game-id">No active game selected.</div>
      {% endif %}
      {% if START_TIME and END_TIME %}
        <div class="game-id">
          Starts: {{ START_TIME }}<br>
          Ends: {{ END_TIME }}
        </div>
      {% endif %}

      {% if PLAYERS %}
        <h3>Players online:</h3><br>
        <div id="onl" data-gameid="{{ ID }}">
          {% for p in PLAYERS %}
            {{p}}<br>
          {% endfor %}
        </div>
      {% endif %}
      
            <div class="portfolio">
        <h3>Your portfolio</h3>
        <div class="portfolio-summary">
          Cash: $<span id="cashValue">{{ "%.2f"|format(CASH or 0) }}</span><br>
          Total portfolio value: $<span id="portValue">{{ "%.2f"|format(PORTVAL or 0) }}</span>
        </div>


        {% if HOLDINGS and HOLDINGS|length > 0 %}
        <table class="holdings">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Shares</th>
              <th>Avg buy price</th>
              <th>Current price</th>
              <th>Position value</th>
              <th>P / L</th>
            </tr>
          </thead>
          <tbody>
            {% for h in HOLDINGS %}
            {% set avg = h.avg_price %}
            {% set cp = h.current_price %}
            {% set val = h.value %}
            {% set pnl = cp * h.shares - (avg or 0) * h.shares %}
            <tr>
              <td>
              <button
              type="button"
              class="ticker-btn"
              data-symbol="{{ h.ticker }}">
              {{ h.ticker }}
            </button>
            </td>
              <td>{{ "%.2f"|format(h.shares) }}</td>
              <td>
                {% if avg is not none %}
                  ${{ "%.2f"|format(avg) }}
                {% else %}
                  –
                {% endif %}
              </td>
              <td>${{ "%.2f"|format(cp) }}</td>
              <td>${{ "%.2f"|format(val) }}</td>
              <td>
                {% if avg is not none %}
                  ${{ "%.2f"|format(pnl) }}
                {% else %}
                  –
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

          <div class="charts-wrapper">
          <div class="chart-box">
            <canvas id="portfolioPie" height="160"></canvas>
          </div>
          <div class="chart-box">
            <canvas id="portfolioLine" height="160"></canvas>
          </div>
        </div>
        {% else %}
          <p>You have no open positions yet. Buy a ticker to populate this view.</p>
        {% endif %}
      </div>

      <form method="post">
        <input type="text" name="ticker" placeholder="Ticker (e.g. AAPL)">
        <input type="number" name="shares" step="0.01" min="0" placeholder="Shares">

        <input type="submit" name="action" value="buy">
        <input type="submit" name="action" value="sell">

        <input type="submit" name="home" value="Home">
        <input type="submit" name="leaveGame" value="Leave Game">
      </form>
    </div>
  </div>
  <div id="chartModal" class="modal hidden">
    <div id="chartBackdrop" class="modal-backdrop"></div>
    <div class="modal-content">
      <button id="chartClose" class="modal-close" type="button">&times;</button>
      <h3 id="chartTitle" style="margin-top:0;margin-bottom:8px;"></h3>
      <div id="tvchart"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let lineChart = null;
  let valuePoints = [];

  function printPlayers(players) {
    const item = document.getElementById('onl');
    item.innerHTML = '';
    players.forEach(element => {
      item.innerHTML += `${element}<br>`;
    });
  }
function updateHoldingsTable(holdings) {
    const tbody = document.querySelector('table.holdings tbody');
    tbody.innerHTML = ''; // clear old rows

    holdings.forEach(h => {
      const avg = h.avg_price;
      const cp = h.current_price;
      const val = h.value;
      const pnl = cp * h.shares - (avg || 0) * h.shares;

      const tr = document.createElement('tr');

      const tdTicker = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'ticker-btn';
      btn.dataset.symbol = h.ticker;
      btn.textContent = h.ticker;
      tdTicker.appendChild(btn);
      tr.appendChild(tdTicker);

      tr.appendChild(Object.assign(document.createElement('td'), { textContent: h.shares.toFixed(2) }));
      tr.appendChild(Object.assign(document.createElement('td'), { textContent: avg !== null ? `$${avg.toFixed(2)}` : '–' }));
      tr.appendChild(Object.assign(document.createElement('td'), { textContent: `$${cp.toFixed(2)}` }));
      tr.appendChild(Object.assign(document.createElement('td'), { textContent: `$${val.toFixed(2)}` }));
      tr.appendChild(Object.assign(document.createElement('td'), { textContent: avg !== null ? `$${pnl.toFixed(2)}` : '–' }));

      tbody.appendChild(tr);
    });
  }

  function timeUpdate() {
    const item = document.getElementById('onl');
    const GameID = item.dataset.gameid;

    fetch(`/updatingGame/${GameID}`, { method: 'GET' })
      .then(response => response.json())
      .then(data => {
        const players = data.PLAYERS || [];
        printPlayers(players);

        // Update the summary text above the charts
        if (typeof data.CASH === 'number') {
          const cashSpan = document.getElementById('cashValue');
          if (cashSpan) cashSpan.textContent = data.CASH.toFixed(2);
        }
        
        if (data.HOLDINGS && data.HOLDINGS.length > 0) {
          updateHoldingsTable(data.HOLDINGS);
        }

        if (typeof data.PORTVAL === 'number') {
          const portSpan = document.getElementById('portValue');
          if (portSpan) portSpan.textContent = data.PORTVAL.toFixed(2);

          valuePoints.push(data.PORTVAL);

         
          const labels = valuePoints.map((_, idx) => idx + 1);

          if (!lineChart) {
            const lineCtx = document.getElementById('portfolioLine').getContext('2d');
            lineChart = new Chart(lineCtx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Portfolio value',
                  data: valuePoints,
                  tension: 0.25,
                  borderWidth: 2,
                  borderColor: '#00c853',               
                  backgroundColor: 'rgba(0, 0, 0, 0)', 
                  pointRadius: 0                         
                }]
              },
              options: {
                plugins: {
                  legend: { labels: { color: '#e8ebf1' } }
                },
                scales: {
                  x: {
                    ticks: { display: false }, 
                    grid: { display: false }
                  },
                  y: {
                    ticks: { color: '#e8ebf1' },
                    grid: { color: '#222b45' }
                  }
                }
              }
            });
          } else {
            // Update existing chart
            lineChart.data.labels = labels;
            lineChart.data.datasets[0].data = valuePoints;
            lineChart.data.datasets[0].borderColor = '#00c853'; 
            lineChart.update();
          }
        }
      });
  }

  timeUpdate();
  setInterval(timeUpdate, 10000);
</script>

  <script>
    const holdingsData = {{ HOLDINGS | tojson | safe }};
    if (holdingsData.length > 0) {
      const pieLabels = holdingsData.map(h => h.ticker);
      const pieValues = holdingsData.map(h => h.value);

      const pieCtx = document.getElementById('portfolioPie').getContext('2d');
      new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: pieLabels,
          datasets: [{ data: pieValues }]
        },
        options: {
          plugins: {
            legend: { labels: { color: '#e8ebf1' } }
          }
        }
      });
    }
  </script>

    <!-- TradingView widget loader for ticker popup -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    (function () {
      const modal     = document.getElementById('chartModal');
      const backdrop  = document.getElementById('chartBackdrop');
      const closeBtn  = document.getElementById('chartClose');
      const titleEl   = document.getElementById('chartTitle');
      const tvContainer = document.getElementById('tvchart');

      function openModal(symbol) {
        if (!symbol) return;
        modal.classList.remove('hidden');
        titleEl.textContent = symbol + " chart";
        tvContainer.innerHTML = "";

        if (window.TradingView) {
          new TradingView.widget({
            container_id: "tvchart",
            symbol: symbol,           // e.g. "AAPL"
            interval: "1",
            timezone: "Etc/UTC",
            theme: "dark",
            style: "1",
            locale: "en",
            autosize: true,
            withdateranges: true,
            allow_symbol_change: false,
            hide_side_toolbar: false,
            hide_top_toolbar: false,
            details: true,
            studies: []
          });
        } else {
          console.error("TradingView not loaded");
        }
      }

      function closeModal() {
        modal.classList.add('hidden');
        tvContainer.innerHTML = "";
      }

      closeBtn.addEventListener('click', closeModal);
      backdrop.addEventListener('click', closeModal);

      // Listen for clicks on any ticker button
      document.addEventListener('click', function (e) {
        if (e.target.matches('.ticker-btn')) {
          const symbol = e.target.dataset.symbol;
          openModal(symbol);
        }
      });
    })();
  </script>
</body>
</html>
